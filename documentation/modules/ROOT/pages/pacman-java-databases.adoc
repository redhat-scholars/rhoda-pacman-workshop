= Connecting to a Database
:navtitle: Connecting to a Database

In this section we will deploy and connect a MongoDB database where the
`pacman` application will store location information.

Finally, we will mark the `pacman` application as a backend for the map
visualization tool, so that it can be dynamically discovered by the `parksmap`
component using the OpenShift discovery mechanism and the map will be displayed
automatically.

image::roadshow-app-architecture-nationalparks-2.png[Application architecture,800,align="center"]

[#storage]
== Background: Storage

Most useful applications are "stateful" or "dynamic" in some way, and this is
usually achieved with a database or other data storage. In this lab we are
going to add MongoDB to our `pacman` application and then rewire it to
talk to the database using environment variables via a secret.

We are going to use the MongoDB image that is included with OpenShift.

By default, this will use *EmptyDir* for data storage, which means if the *Pod*
disappears the data does as well. In a real application you would use
OpenShift's persistent storage mechanism to attach real-world storage (NFS,
Ceph, EBS, iSCSI, etc) to the *Pods* to give them a persistent place to store their
data.

[#challenges_dbaas]
== Background: DBaaS & Present Challenges

image::challenge.png[DBaaS & Present Challenges,800,align="center"]


[#sol_rh_dbaas]
== Background: Red Hat Solution

More efficient connection, DB utilization
Faster and easier self-service for developers
Centralized monitoring, consistent control plane for admins

image::solution.png[Red Hat Solution,800,align="center"]

[#bg_sb_lib]
== Background: Service binding libraries
The Kubernetes service binding feature was introduced to bring consistency to the way secrets are shared for connecting applications to external services, such as REST APIs, databases, and many other services.
OpenShift Database Access leverages the service binding feature to bring a low-touch administrative experience to provisioning, and managing access to external database services.
The service binding feature enables developers to connect their applications to database services with a consistent, and predictable experience.
Specifically, a service binding creates a volume on the application pod, and organizes the information to make a connection to the database in a directory structure.
The volume mount point is exposed as an environment variable.
Developer frameworks, such as Quarkus, are service binding aware, and can automatically connect to a database using this exposed workload information without needing to embed database connection information in the application source code.

Here are some application examples on how to use a service binding library:

* link:https://github.com/RHEcosystemAppEng/mongo-quickstart[Mongo Quarkus application]
* link:https://github.com/RHEcosystemAppEng/postgresql-orm-quickstart[Crunchy Postgres Quarkus application]
* link:https://github.com/myeung18/postgresql-orm-demo-app[CockroachDB Postgres Quarkus application]
* link:https://github.com/myeung18/cockroachdb-go-quickstart[CockroachDB Postgres Go application]
* link:https://github.com/RHODA-lab/rhoda-qa-python/blob/main/run-test.py[Crunchy Postgres Python test program]
* link:https://github.com/RHODA-lab/rhoda-qa-python/blob/main/test-cockroachdb.py[CockroachDB Postgres Python test program]

[role="_additional-resources"]
.Additional resources

* See the link:https://github.com/servicebinding/spec#workload-projection[Kubernetes GitHub project] for more details on service bindings.

[#prereq_rhoda]
== Prerequisites: Things to Do before configuring MongoDB Atlas

* A Red Hat user account to access the link:https://console.redhat.com/[Red Hat Hybrid Cloud Console].
* An instance of OpenShift Container Platform (OCP) 4.9 or higher running on Red Hat OpenShift Dedicated (OSD), or Red Hat OpenShift Service on AWS (ROSA).
** When using OSD or ROSA, an Amazon Web Services (AWS) account and credentials are required.
* Access to the OpenShift Cluster Manager (OCM) console.
* A service account with either the link:https://www.mongodb.com/atlas/database[MongoDB Atlas], or link:https://www.crunchydata.com[Crunchy Data Bridge], or link:https://www.cockroachlabs.com[CockroachDB] cloud database provider.
* An existing database instance running on one of these cloud database providers: MongoDB Atlas, Crunchy Data Bridge, or CockroachDB.

In order to run the lab in your cluster, you need to meet the requirements discussed below.

[cols="2*^,2*.",options="header,+attributes"]
|===
|**Component**|**Version**

| https://www.openshift.com/try[OpenShift]
| `{openshift-version}`
|===

In the following modules you will find out other prerequisites when needed.


[#deploy_mongodb]
== Exercise: Deploy MongoDB




















[#access_mongodb]
== Exercise : Accessing the database access menu for configuring and monitoring

















[#find_mongodb_creds]
== Exercise: Find your MongoDB Atlas account credentials

You need the Organization ID, the Organization Public Key, and the Organization Private Key to create a provider account resource for MongoDB Atlas.

[IMPORTANT]
====
If using MongoDB Atlas as a cloud-database provider, then you must add the IP address of the application pod to MongoDB Atlas' IP Access List.
If the IP address is not in the IP Access List, then a 504 gateway timeout error occurs.
Visit the MongoDB Atlas link:https://docs.atlas.mongodb.com/security/ip-access-list/[website] for more details on adding an IP address to your database project.
====

.Procedure

. From the MongoDB Atlas link:https://www.mongodb.com/[home page], **Sign In** to your account.

. From your account home page:
+
image::mongodb_first_single_screen_all_step.png[Single screenshot for finding your Organization ID value]

.. Select **Organization** from the dropdown menu image:1st_Callout_Bullet.png[First callout].

.. Click **Settings** from the Organization navigation menu image:2nd_Callout_Bullet.png[Second callout].

.. Copy the Organization ID value image:3rd_Callout_Bullet.png[Third callout].
+
NOTE: In some cases your organization ID may be hidden by default.

. Next, from the account home page:
+
image::mongodb_second_single_screen_all_step.png[Single screenshot for finding your API keys]

.. Click **Access Manager** from the **Organization** navigation menu image:1st_Callout_Bullet.png[First callout].

.. Click **API Keys** image:2nd_Callout_Bullet.png[Second callout].

.. If you have existing API keys, you can find them listed here.
Copy the API public and private keys for the import provider account fields.
Also, verify that your API keys have the **Organization Owner** and **Organization Member** permissions image:3rd_Callout_Bullet.png[Third callout] image:4th_Callout_Bullet.png[Fourth callout].

. If you need new API keys, click **Create API Key**, and proceed to the next step.
+
//image::rhoda_mongodb_create_api_key_button.png[Create API Key button]

. On the **Create API Key** page, enter a **Description**, and under the **Organization Permissions** dropdown box select the **Organization Owner** and **Organization Member** permissions.
Click **Next**.
+
//image::rhoda_mongodb_create_api_dialog_permissions.png[Create API Key permissions]

. Copy the API public and private keys for the import provider account fields.

[#dev_add_db]
== Exercise: Accessing the developer workspace and adding a database instance

You can access the developer workspace in the OpenShift console to manage connectivity between database instances and applications.

.Prerequisites

* xref:installing-the-red-hat-openshift-database-access-add-on_{context}[Installation] of the OpenShift Database Access add-on.
* xref:accessing-the-database-access-menu-for-configuring-and-monitoring_{context}[Import] at least one cloud-database provider account.

.Procedure

. Log into the OpenShift console.

. Access the developer workspace, and select or create your project, then select a cloud-hosted database provider to add to your project:
+
image::rhoda_dev_entry_point_single_page_all_steps.png[Single page screenshot of the developer's entry point]

.. Select the **Developer** perspective image:1st_Callout_Bullet.png[First callout].

.. Click **+Add** image:2nd_Callout_Bullet.png[Second callout].

.. Click the **Project** dropdown menu image:3rd_Callout_Bullet.png[Third callout].

.. Create a new project or search for your application’s project image:4th_Callout_Bullet.png[Fourth callout].

.. Select the **Cloud-Hosted Databases** tile to connect to a cloud-database provider image:5th_Callout_Bullet.png[Fifth callout].

. Select your cloud-hosted database provider tile.

. Click **Add to Topology**.

. Select a previously configured **Provider Account** for this database instance from the dropdown menu.

. Select the database instance ID you want to use, and then click **Add to Topology**.

. Click **Continue**.
Upon a successful connection, you are taken to the xref:connecting-an-application-to-a-database-instance-using-the-topology-view_{context}[**Topology**] page.


= Accessing the developer workspace and adding a database instance

[role="_abstract"]
You can access the developer workspace in the OpenShift console to manage connectivity between database instances and applications.

.Prerequisites

* xref:installing-the-red-hat-openshift-database-access-add-on_{context}[Installation] of the OpenShift Database Access add-on.
* xref:accessing-the-database-access-menu-for-configuring-and-monitoring_{context}[Import] at least one cloud-database provider account.

.Procedure

. Log into the OpenShift console.

. Access the developer workspace, and select or create your project, then select a cloud-hosted database provider to add to your project:
+
image::rhoda_dev_entry_point_single_page_all_steps.png[Single page screenshot of the developer's entry point]

.. Select the **Developer** perspective image:1st_Callout_Bullet.png[First callout].

.. Click **+Add** image:2nd_Callout_Bullet.png[Second callout].

.. Click the **Project** dropdown menu image:3rd_Callout_Bullet.png[Third callout].

.. Create a new project or search for your application’s project image:4th_Callout_Bullet.png[Fourth callout].

.. Select the **Cloud-Hosted Databases** tile to connect to a cloud-database provider image:5th_Callout_Bullet.png[Fifth callout].

. Select your cloud-hosted database provider tile.

. Click **Add to Topology**.

. Select a previously configured **Provider Account** for this database instance from the dropdown menu.

. Select the database instance ID you want to use, and then click **Add to Topology**.

. Click **Continue**.
Upon a successful connection, you are taken to the xref:connecting-an-application-to-a-database-instance-using-the-topology-view_{context}[**Topology**] page.










[#explore_rhoda_magic]
== Exercise: Navigate through Data Services Console
















[#explore_rhoda_magic]
== Exercise: Navigate through Data Services Console














[#play_pacman]
== Exercise: Play Pacman and save your high scores

Pacman URL : https://pacman-git-managed-pacman.apps.rhodalab.yoir.p1.openshiftapps.com/

image::pacman.png.png[Pacman Game,800,align="center"]
