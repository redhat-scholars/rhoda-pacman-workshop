= Connecting to a Managed Database
:navtitle: Connecting to MongoDB Atlas Cloud Database

In this section we will deploy and connect to a MongoDB Atlas Cloud Database where the
`pacman` application will store  information such as high scores and user stats.


image::pman.png[Application architecture,800,align="center"]


[#prereq_rhoda]
== Prerequisites: Things to be in place already before configuring MongoDB Atlas

* A Red Hat user account to access the link:https://console.redhat.com/[Red Hat Hybrid Cloud Console].
* An instance of OpenShift Container Platform (OCP) 4.9 or higher running on Red Hat OpenShift Dedicated (OSD), or Red Hat OpenShift Service on AWS (ROSA).
** When using OSD or ROSA, an Amazon Web Services (AWS) account and credentials are required.
* Access to the OpenShift Cluster Manager (OCM) console.
* A service account with either the link:https://www.mongodb.com/atlas/database[MongoDB Atlas], or link:https://www.crunchydata.com[Crunchy Data Bridge], or link:https://www.cockroachlabs.com[CockroachDB] cloud database provider.
* An existing database instance running on one of these cloud database providers: MongoDB Atlas, Crunchy Data Bridge, or CockroachDB.

In order to run the lab in your cluster, you need to meet the requirements discussed below.

[cols="2*^,2*.",options="header,+attributes"]
|===
|**Component**|**Version**

| https://www.openshift.com/try[OpenShift]
| `{openshift-version}`
|===

In the following modules you will find out other prerequisites when needed.

[#deploy_rhoda]
== Exercise: Deploy RHODA

Normally operators can be deployed from Operator Hub by selecting the Operator from Operator Hub and we can also use Ansible to deploy Operators depending on deployment techniques that are already adopted by the teams.

Using CLI
Install Web Terminal Operator and  and launch terminal from OpenShift Console
To install Web Terminal, please follow the following instructions : https://docs.openshift.com/container-platform/4.10/web_console/odc-about-web-terminal.html


Create the RHODA catalog source by running the following commands.

Note: The catalog source image repo can be the users local repo or developers space or SRE/OSD release image repo. For Service Preview release we will use RHODA SRE/OSD addon release image repo.

image::rhoda1.png[Application architecture,800,align="center"]


Verify that the catalog source is added with the following command

----
oc get catalogsource dbaas-operator -n openshift-marketplace
----


Verify that dbaas-operator catalog source is in READY state, It might take a few minutes before the catalog source is ready. If the below command does not return READY, wait a few minutes and try to verify the status again. You can also check this by going into openshift-marketplace namespace dbass-operator catalog pod

----
oc get catalogsource -n openshift-marketplace  dbaas-operator -o jsonpath='{.status.connectionState.lastObservedState} {"\n"}'
----
Verify if required any other details with below command (optional)
----
oc describe packagemanifests dbaas-operator -n openshift-marketplace
----
Verify if required any other details with below command (optional)
----
oc describe packagemanifests dbaas-operator -n openshift-marketplace
----

Go to Operator Hub and look for OpenShift Database Access Operator

image::rhoda5.png[Application architecture,800,align="center"]

Once Selected the OpenShift Database Access Operator,

Navigate in the web console to the Operators → OperatorHub page.
Type a keyword into the Filter by keyword box OpenShift Database Access Operator.
Select the OpenShift Database Access Operator  to display additional information.

image::rhoda6.png[Application architecture,800,align="center"]

On the Install Operator page. The RHODA operator is cluster scope and the default installed namespace is openshift-dbaas-operator and use the same default settings.

image::rhoda7.png[Application architecture,800,align="center"]

On successful installation of RHODA operator, will automatically install all its dependencies including provider operators, console plugins as seen in the screenshot and you see an additional menu with name Data Services in the end of menu list. Once all it’s components installation completed the dbaas operator pod logs will shows: DBaaS platform stack installation complete.

image::rhoda8.png[Application architecture,800,align="center"]

image::rhoda9.png[Application architecture,800,align="center"]


Verify the installation completion logs

image::rhoda11.png[Application architecture,800,align="center"]

  Repeat Steps above from 1 -7 in the ARO and ROSA Clusters as well to ensure we have RHODA installed on all of the three clusters

 Create a Provider Account depending on the the managed database that the application needs to connect to

 To create a Provide Account, please refer to the documentation : 


In the Developer Perspective, click add and select connect database from the list of available options on each cluster.

image::rhoda22.png[Application architecture,800,align="center"]

Once above step is performed, you would be able to see as shown below in developer perspective

image::rhoda33.png[Application architecture,800,align="center"]

Finally, to connect application to the database, we need to create a service binding by doing a drag and drop from the application to the connected database which will prompt a message as shown below

image::rhoda44.png[Application architecture,800,align="center"]

After successfully creating the service binding application will be connected to the database

image::rhoda55.png[Application architecture,800,align="center"]

[#access_mongodb]
== Exercise : Accessing the database access menu for configuring and monitoring

You can access the Red Hat OpenShift Database Access page from the OpenShift console navigation menu to select the correct project namespace for importing a cloud-database provider account.

[IMPORTANT]
====
If using MongoDB Atlas as a cloud-database provider, then you must add the IP address of the application pod to MongoDB Atlas' **IP Access List**.
If the IP address is not in the **IP Access List**, then a `504 gateway timeout error` occurs.
Visit the MongoDB Atlas link:https://docs.atlas.mongodb.com/security/ip-access-list/[website] for more details on adding an IP address to your database project.
====

.Prerequisites

* A service account with either the link:https://www.mongodb.com/atlas/database[MongoDB Atlas], or link:https://www.crunchydata.com[Crunchy Data Bridge], or link:https://www.cockroachlabs.com[CockroachDB] cloud database provider.

.Procedure

. Log into the OpenShift console.

. To select the correct project namespace follow these sub-steps.
+
image::rhoda_admin_entry_point_single_page_all_steps.png[Single page screenshot of the administrator's entry point]

.. Select the **Administrator** perspective image:1st_Callout_Bullet.png[First callout].

.. Expand the **Data Services** navigation menu, and click **Database Access** image:2nd_Callout_Bullet.png[Second callout].
+
NOTE: You might need to scroll down the navigation menu.

.. Click the **Project** dropdown menu and then enable the **Show default projects** switch image:3rd_Callout_Bullet.png[Third callout].

.. Type **dbaas** in the search field.

.. Select **redhat-dbaas-operator** or **openshift-dbaas-operator** project namespace image:4th_Callout_Bullet.png[Fourth callout].
+
From the database inventory page you can monitor the database environment, import cloud-hosted database provider accounts, or create new database instances.
+
image::rhoda_admin_entry_point_inventory_page.png[Database inventory landing page]

////
[role="_additional-resources"]
.Additional Resources

* See link:{rhoda-prod-doc-url}#finding-your-cloud-database-provider-account-credentials[_Appendix A_] in the _Red Hat OpenShift Database Access Quick Start Guide_ for help in finding your provider account information.
* The MongoDB Atlas link:https://www.mongodb.com/cloud/atlas[home page].
* The Crunchy Data Bridge link:https://www.crunchydata.com[home page].
* The CockroachDB link:https://www.cockroachlabs.com[home page].
////

















[#find_mongodb_creds]
== Exercise: Find your MongoDB Atlas account credentials

You need the Organization ID, the Organization Public Key, and the Organization Private Key to create a provider account resource for MongoDB Atlas.

[IMPORTANT]
====
If using MongoDB Atlas as a cloud-database provider, then you must add the IP address of the application pod to MongoDB Atlas' IP Access List.
If the IP address is not in the IP Access List, then a 504 gateway timeout error occurs.
Visit the MongoDB Atlas link:https://docs.atlas.mongodb.com/security/ip-access-list/[website] for more details on adding an IP address to your database project.
====

.Procedure

. From the MongoDB Atlas link:https://www.mongodb.com/[home page], **Sign In** to your account.

. From your account home page:
+
image::mongodb_first_single_screen_all_step.png[Single screenshot for finding your Organization ID value]

.. Select **Organization** from the dropdown menu image:1st_Callout_Bullet.png[First callout].

.. Click **Settings** from the Organization navigation menu image:2nd_Callout_Bullet.png[Second callout].

.. Copy the Organization ID value image:3rd_Callout_Bullet.png[Third callout].
+
NOTE: In some cases your organization ID may be hidden by default.

. Next, from the account home page:
+
image::mongodb_second_single_screen_all_step.png[Single screenshot for finding your API keys]

.. Click **Access Manager** from the **Organization** navigation menu image:1st_Callout_Bullet.png[First callout].

.. Click **API Keys** image:2nd_Callout_Bullet.png[Second callout].

.. If you have existing API keys, you can find them listed here.
Copy the API public and private keys for the import provider account fields.
Also, verify that your API keys have the **Organization Owner** and **Organization Member** permissions image:3rd_Callout_Bullet.png[Third callout] image:4th_Callout_Bullet.png[Fourth callout].

. If you need new API keys, click **Create API Key**, and proceed to the next step.
+
//image::rhoda_mongodb_create_api_key_button.png[Create API Key button]

. On the **Create API Key** page, enter a **Description**, and under the **Organization Permissions** dropdown box select the **Organization Owner** and **Organization Member** permissions.
Click **Next**.
+
//image::rhoda_mongodb_create_api_dialog_permissions.png[Create API Key permissions]

. Copy the API public and private keys for the import provider account fields.

[#dev_add_db]
== Exercise: Accessing the developer workspace and adding a database instance

You can access the developer workspace in the OpenShift console to manage connectivity between database instances and applications.

.Prerequisites

* xref:installing-the-red-hat-openshift-database-access-add-on[Installation] of the OpenShift Database Access add-on.
* xref:accessing-the-database-access-menu-for-configuring-and-monitoring_[Import] at least one cloud-database provider account.

.Procedure

. Log into the OpenShift console.

. Access the developer workspace, and select or create your project, then select a cloud-hosted database provider to add to your project:
+
image::rhoda_dev_entry_point_single_page_all_steps.png[Single page screenshot of the developer's entry point]

.. Select the **Developer** perspective image:1st_Callout_Bullet.png[First callout].

.. Click **+Add** image:2nd_Callout_Bullet.png[Second callout].

.. Click the **Project** dropdown menu image:3rd_Callout_Bullet.png[Third callout].

.. Create a new project or search for your application’s project image:4th_Callout_Bullet.png[Fourth callout].

.. Select the **Cloud-Hosted Databases** tile to connect to a cloud-database provider image:5th_Callout_Bullet.png[Fifth callout].

. Select your cloud-hosted database provider tile.

. Click **Add to Topology**.

. Select a previously configured **Provider Account** for this database instance from the dropdown menu.

. Select the database instance ID you want to use, and then click **Add to Topology**.

. Click **Continue**.
Upon a successful connection, you are taken to the xref:connecting-an-application-to-a-database-instance-using-the-topology-view[**Topology**] page.


[#explore_rhoda_magic]
== Exercise: Navigate through Data Services Console
You can access the Red Hat OpenShift Database Access page from the OpenShift console navigation menu to select the correct project namespace for importing a cloud-database provider account.

[IMPORTANT]
====
If using MongoDB Atlas as a cloud-database provider, then you must add the IP address of the application pod to MongoDB Atlas' **IP Access List**.
If the IP address is not in the **IP Access List**, then a `504 gateway timeout error` occurs.
Visit the MongoDB Atlas link:https://docs.atlas.mongodb.com/security/ip-access-list/[website] for more details on adding an IP address to your database project.
====

.Prerequisites

* A service account with either the link:https://www.mongodb.com/atlas/database[MongoDB Atlas], or link:https://www.crunchydata.com[Crunchy Data Bridge], or link:https://www.cockroachlabs.com[CockroachDB] cloud database provider.

.Procedure

. Log into the OpenShift console.

. To select the correct project namespace follow these sub-steps.
+
image::rhoda_admin_entry_point_single_page_all_steps.png[Single page screenshot of the administrator's entry point]

.. Select the **Administrator** perspective image:1st_Callout_Bullet.png[First callout].

.. Expand the **Data Services** navigation menu, and click **Database Access** image:2nd_Callout_Bullet.png[Second callout].
+
NOTE: You might need to scroll down the navigation menu.

.. Click the **Project** dropdown menu and then enable the **Show default projects** switch image:3rd_Callout_Bullet.png[Third callout].

.. Type **dbaas** in the search field.

.. Select **redhat-dbaas-operator** or **openshift-dbaas-operator** project namespace image:4th_Callout_Bullet.png[Fourth callout].
+
From the database inventory page you can monitor the database environment, import cloud-hosted database provider accounts, or create new database instances.
+
image::rhoda_admin_entry_point_inventory_page.png[Database inventory landing page]




















[#play_pacman]
== Exercise: Play Pacman and save your high scores

Pacman URL : https://pacman-git-managed-pacman.apps.rhodalab.yoir.p1.openshiftapps.com/

image::pacman.png[Pacman Game,800,align="center"]
