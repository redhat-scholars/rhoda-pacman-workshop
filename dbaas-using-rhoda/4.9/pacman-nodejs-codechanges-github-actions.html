<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>GitHub Actions with OpenShift :: Connecting Applications to DBaaS using RHODA</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/course-template/dbaas-using-rhoda/4.10.17/pacman-nodejs-codechanges-github-actions.html">
    <link rel="prev" href="pacman-nodejs-codechanges-github.html">
    <link rel="next" href="pacman-nodejs-pipeline.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://redhat-scholars.github.io/course-template">Connecting Applications to DBaaS using RHODA</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="dbaas-using-rhoda" data-version="4.9">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Connecting Applications to DBaaS using RHODA</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="common-workshop-summary.html">Workshop</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="common-environment.html">OpenShift Architecture</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="common-explore.html">Explore OpenShift</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="common-explore.html#the_web_console">The Web Console</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="common-explore.html#command_line_interface">Command Line Interface</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="common-explore.html#download_openshift_cli">Download OpenShift CLI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="common-explore.html#use_web_terminal">Web Terminal</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="common-explore.html#connect_to_the_cluster_with_cli">Connect to the OpenShift Cluster from CLI</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="common-explore.html#working_with_proxies">Working with proxies</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="prerequisites.html">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="pacman-nodejs-bg.html">Before we begin</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pacman-nodejs-bg.html#challenges_dbaas">DBaaS &amp; Present Challenges</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pacman-nodejs-bg.html#sol_rh_dbaas">Red Hat Solution</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pacman-nodejs-bg.html#bg_sb_lib">Service binding libraries</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="deploy-rhoda.html">Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="deploy-rhoda.html#deploy_web_terminal">OpenShift Web Terminal</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="deploy-rhoda.html#deploy_kustomize">Kustomize</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="deploy-rhoda.html#deploy_ansible">Ansible</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="deploy-rhoda.html#deploy_rhacm">RHACM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="deploy-rhoda.html#deploy_ocp_pipelines">OpenShift Pipelines</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="explore-rhoda.html">Explore RHODA</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="explore-rhoda.html#explore_cli">OpenShift CLI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="explore-rhoda.html#explore_web_console">OpenShift Web console</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="projects.html">Projects</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="projects.html#create_pacman_project">Create Pacman Project</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="common-pacman-architecture.html">Pacman Architecture</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="pacman-nodejs.html">Pacman App</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pacman-nodejs.html#source_to_image">Background: Source-to-Image (S2I)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="pacman-nodejs.html#creating_nodejs_application">Exercise: Creating a Pacman application</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="pacman-nodejs.html#add_to_project">Add to Project</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="pacman-nodejs.html#using_application_code_on_git_server">Using Application Code on a Git Server</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="pacman-nodejs.html#build_code_on_openshift">Build the Code on OpenShift</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="pacman-nodejs-databases.html">Connecting Pacman to MongoDB Atlas Cloud Database Instance</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pacman-nodejs-databases.html#prereq_rhoda">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pacman-nodejs-databases.html#access_mongodb">Exercise: Accessing the database access menu for configuring and monitoring</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pacman-nodejs-databases.html#find_mongodb_creds">Exercise: Find your MongoDB Atlas account credentials</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pacman-nodejs-databases.html#dev_add_db">Exercise: Accessing the developer workspace and adding a database instance</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pacman-nodejs-databases.html#play_pacman">Exercise: Play Pacman and save your high scores</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="pacman-nodejs-codechanges-github.html">Webhooks with OpenShift</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pacman-nodejs-codechanges-github.html#prerequisite_github_account">Prerequisite: GitHub Account</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pacman-nodejs-codechanges-github.html#webhooks">Webhooks</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pacman-nodejs-codechanges-github.html#webhooks_with_openshift">Webhooks with OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pacman-nodejs-codechanges-github.html#configuring_github_webhooks">Exercise: Configuring GitHub Web Hooks</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pacman-nodejs-codechanges-github.html#using_github_webhooks">Exercise: Using GitHub Web Hooks</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="pacman-nodejs-codechanges-github-actions.html">GitHub Actions with OpenShift</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#disable_github_webhook">Disable GitHub Webhook</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#disable_openshift_triggers">Disable OpenShift Triggers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#configure_github_action">Configure GitHub Action</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#add_github_action">Add GitHub Action</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#enable_openshift_triggers">Enable OpenShift Triggers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="pacman-nodejs-pipeline.html">Continuous Integration and Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pacman-nodejs-pipeline.html#install_openshift_pipelines_from_operatorhub">Install OpenShift Pipelines from OperatorHub</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pacman-nodejs-pipeline.html#understanding_tekton">Understanding Tekton</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pacman-nodejs-pipeline.html#create_your_pipeline">Create Your Pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pacman-nodejs-pipeline.html#run_the_pipeline">Run the Pipeline</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="common-further-resources.html">Further Resources</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="common-workshop-links.html">Workshop Links</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="common-workshop-links.html#openshift_cluster_url">OpenShift Cluster URL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="common-workshop-links.html#workshop_guides">Workshop Guides</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="common-workshop-links.html#web_terminal">Web terminal</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="common-workshop-links.html#git_server">Git Server</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Connecting Applications to DBaaS using RHODA</span>
    <span class="version">4.9</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Connecting Applications to DBaaS using RHODA</span>
      <ul class="versions">
        <li class="version">
          <a href="../4.10.17/index.html">4.10.17</a>
        </li>
        <li class="version is-current">
          <a href="index.html">4.9</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../4.10.17/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Connecting Applications to DBaaS using RHODA</a></li>
    <li><a href="pacman-nodejs-codechanges-github-actions.html">GitHub Actions with OpenShift</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">4.9</button>
  <div class="version-menu">
    <a class="version" href="../4.10.17/pacman-nodejs-codechanges-github-actions.html">4.10.17</a>
    <a class="version is-current" href="pacman-nodejs-codechanges-github-actions.html">4.9</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/rhoda-pacman-workshop/edit/4.9/documentation/modules/ROOT/pages/pacman-nodejs-codechanges-github-actions.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">GitHub Actions with OpenShift</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>OpenShift includes comprehensive features for automation in-cluster as seen in <a href="pacman-nodejs-codechanges-github.html" class="xref page">Webhooks with OpenShift</a> and as you will see in the next chapter <a href="pacman-nodejs-pipeline.html" class="xref page">Continuous Integration and Pipelines</a>. In addition to that, it provides great interoperability and integrations for external CI/CD systems such as Jenkins, GitLab, Azure DevOps and <strong>GitHub Actions</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/openshift-cicd-integrations.png" alt="OpenShift CI/CD Offering">
</div>
</div>
<div class="paragraph">
<p><a href="https://docs.github.com/en/actions/learn-github-actions/understanding-github-actions#overview" target="_blank" rel="noopener">GitHub Actions</a> are event-driven automation tasks available for any GitHub repository. An event automatically triggers the workflow, which contains a job. The job then uses steps to control the order in which actions are run. These actions are the commands that automate software build, test and deploy.</p>
</div>
<div class="paragraph">
<p>In this chapter, you will add a GitHub Action for building the pacman backend container image, and pushing it to the <a href="https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry" target="_blank" rel="noopener">GitHub Container Registry</a>. Any change to your fork will trigger the container image build and push outside OpenShift this time, and this will be used afterwards to deploy the new container image to OpenShift.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="disable_github_webhook"><a class="anchor" href="#disable_github_webhook"></a>Disable GitHub Webhook</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the previous chapter we also used Webhooks to trigger the container image build and deploy through the BuildConfig automation.
At this point, we need to disable or cancel it because we will use GitHub Actions for that.</p>
</div>
<div class="paragraph">
<p>Come back to your pacman fork page on GitHub. From top-right menu, click <strong>Settings</strong>. Then from result left-side menu, click <strong>Webhook</strong>, then click <strong>Delete</strong> next to your previously created Webhook.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can also just disable it, by clicking on <strong>Edit</strong> and then navigate to the bottom of the section to uncheck <strong>Active</strong> box.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="disable_openshift_triggers"><a class="anchor" href="#disable_openshift_triggers"></a>Disable OpenShift Triggers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As we discussed in the previous chapter, OpenShift provides in-cluster automation out the box with Webhooks and BuildConfigs.
Because now we want to delegate this automation externally to GitHub Actions, we need to disable such triggers for the Nationalparks Deployment with this command:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc annotate deployment pacman image.openshift.io/triggers-
oc annotate deployment pacman alpha.image.policy.openshift.io/resolve-names-</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure_github_action"><a class="anchor" href="#configure_github_action"></a>Configure GitHub Action</h2>
<div class="sectionbody">
<div class="paragraph">
<p>GitHub Actions workflows run into <a href="https://docs.github.com/en/actions/reference/environments" target="_blank" rel="noopener">Environments</a> and they can reference an environment to use the environment&#8217;s protection rules and secrets.</p>
</div>
<div class="paragraph">
<p>In this step, you will add a new Environment named <code>development</code>.</p>
</div>
<div class="paragraph">
<p>From your previously forked pacman repository on GitHub, go to the top-right menu, click <strong>Settings</strong>. Then from result left-side menu, click <strong>Environments</strong>, then from right side click <strong>New environment</strong>.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="ghaction.png" alt="Environment">
</div>
</div>
<div class="paragraph">
<p>In the following window, insert into <strong>Name</strong> the name of the GitHub Environment that will be used by the Action:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">development</code></pre>
</div>
</div>
<div class="paragraph">
<p>Click <strong>Configure Environment</strong> to create it.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="ghaction" alt="Add Environment">
</div>
</div>
<div class="paragraph">
<p>In the result screen from your just created GitHub Environment <code>development</code>, you will see all details of the newly created Enviroment. Navigate to the bottom of section, go to <strong>Environment secrets</strong> and click <strong>Add Secret</strong> to add new secrets.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="ghactiong" alt="Add Environment Secrets">
</div>
</div>
<div class="paragraph">
<p>You will now configure two secrets that will be used by the GitHub Action to connect to your OpenShift clusters.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>OPENSHIFT_SERVER</code>: The OpenShift API server</p>
</li>
<li>
<p><code>OPENSHIFT_TOKEN</code>: The authentication token to connect with</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can retrieve both from your OpenShift cluster as shown in previous chapter: <a href="common-explore.html#connect_to_the_cluster_with_cli" class="xref page" target="_blank" rel="noopener">Connect to the OpenShift Cluster from CLI</a>:</p>
</div>
<div class="paragraph">
<p>In another tab, go back to OpenShift Web Console. Then go to top-right menu bar and click to the dropdown menu containing your username, then click <strong>Copy Login Command</strong>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/prerequisites_copy_login_command.png" alt="Copy Login Command">
</div>
</div>
<div class="paragraph">
<p>Click on <strong>Display Token</strong>.</p>
</div>
<div class="paragraph">
<p>Copy your <strong>OPENSHIFT_SERVER</strong> as shown in the image below, in the <strong>Log in with this token</strong> section (e.g. <code>https://api.sandbox-m2.cafe.p1.openshiftapps.com:6443</code>)</p>
</div>
<div class="paragraph">
<p>Copy your <strong>OPENSHIFT_TOKEN</strong> as shown in the image below, in the <strong>Your API token is</strong> section (e.g. <code>sha256~IJlITptYEdthK-&#8230;&#8203;&#8230;&#8203;</code>)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/nationalparks-codechanges-github-actions-token.png" alt="Environment">
</div>
</div>
<div class="paragraph">
<p>Add both <code>OPENSHIFT_SERVER</code> and <code>OPENSHIFT_TOKEN</code> with the values you just copied:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/nationalparks-codechanges-github-actions-addsecret.png" alt="Add Secret">
</div>
</div>
<div class="paragraph">
<p>Click <strong>Add Secret</strong> to add one and repeat for the other.</p>
</div>
<div class="paragraph">
<p>Your Environment screen should be similar to the following:</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="ghaction" alt="Added Environment Secrets">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="add_github_action"><a class="anchor" href="#add_github_action"></a>Add GitHub Action</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Everything is now ready to start your automation with GitHub Action and OpenShift. GitHub actions workflows and jobs are defined with a YAML file containing all the needed steps.</p>
</div>
<div class="paragraph">
<p>Review the follow workflow that will be used to trigger build of the pacman backend on GitHub, and then deploy it to OpenShift referencing container image from the already created Deployment <code>pacman</code>.</p>
</div>
<div class="paragraph">
<p><strong>Copy</strong> the YAML file to be added in your pacman fork repository on GitHub.</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: OpenShift <i class="conum" data-value="1"></i><b>(1)</b>

env: <i class="conum" data-value="2"></i><b>(2)</b>
  IMAGE_REGISTRY: ghcr.io/${{ github.repository_owner }}
  REGISTRY_USER: ${{ github.actor }}
  REGISTRY_PASSWORD: ${{ github.token }}
  APP_NAME: pacman
  IMAGE_TAGS: latest ${{ github.sha }}

  OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
  OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
  OPENSHIFT_NAMESPACE: "%PROJECT%"

  APP_PORT: "8080"

on:
  # https://docs.github.com/en/free-pro-team@latest/actions/reference/events-that-trigger-workflows
  push: <i class="conum" data-value="3"></i><b>(3)</b>
    branches: [ master ]

jobs:
  build-and-push: <i class="conum" data-value="4"></i><b>(4)</b>
    name: Build and push to github container registry
    runs-on: ubuntu-18.04
    environment: development

    outputs:
        ROUTE: ${{ steps.deploy-and-expose.outputs.route }}
        SELECTOR: ${{ steps.deploy-and-expose.outputs.selector }}

    steps:
    - name: Checkout
      id: checkout
      uses: actions/checkout@v2

   # https://github.com/redhat-actions/s2i-build#readme
    - name: S2I Build <i class="conum" data-value="5"></i><b>(5)</b>
      id: build_image
      uses: redhat-actions/s2i-build@v2
      with:
        path_context: '.'
        builder_image: 'registry.access.redhat.com/ubi8/openjdk-11'
        image: ${{ env.APP_NAME }}
        tags: ${{ env.IMAGE_TAGS }}

    # https://github.com/redhat-actions/push-to-registry#readme
    - name: Push to Registry <i class="conum" data-value="6"></i><b>(6)</b>
      id: push-to-registry
      uses: redhat-actions/push-to-registry@v2
      with:
        image: ${{ steps.build_image.outputs.image }}
        tags: ${{ steps.build_image.outputs.tags }}
        registry: ${{ env.IMAGE_REGISTRY }}
        username: ${{ env.REGISTRY_USER }}
        password: ${{ env.REGISTRY_PASSWORD }}

    # The path the image was pushed to is now stored in ${{ steps.push-to-registry.outputs.registry-path }}

    # https://github.com/redhat-actions/oc-login#readme
    - name: Log in to OpenShift <i class="conum" data-value="7"></i><b>(7)</b>
      uses: redhat-actions/oc-login@v1
      with:
        openshift_server_url: ${{ env.OPENSHIFT_SERVER }}
        openshift_token: ${{ env.OPENSHIFT_TOKEN }}
        insecure_skip_tls_verify: true
        namespace: ${{ env.OPENSHIFT_NAMESPACE }}

    # Run a script to create a new app or update the current one with the previously pushed container image
    - run: | <i class="conum" data-value="8"></i><b>(8)</b>
         "${GITHUB_WORKSPACE}/.github/script.sh" ${{ env.APP_NAME }} ${{ env.IMAGE_REGISTRY }}/${{ steps.build_image.outputs.image }}:${{ github.sha }} ${{ env.OPENSHIFT_NAMESPACE }}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Name of the Action.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Environment variables to be used in the workflow. This includes <a href="https://docs.github.com/en/actions/reference/environment-variables" target="_blank" rel="noopener">default environment variables</a> and the Secret you added to the Enviroment.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Here&#8217;s if where you define which type of trigger you want for this workflow. In this case, any change to the repository (Push) to the <code>master</code> branch will trigger the action start. Check out the documentation for a full list of triggers that can be used: <a href="https://docs.github.com/en/free-pro-team@latest/actions/reference/events-that-trigger-workflows" class="bare">https://docs.github.com/en/free-pro-team@latest/actions/reference/events-that-trigger-workflows</a></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Name of the job running in this Action. This will use an ubuntu image containing OpenShift CLI <code>oc</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><a href="https://github.com/redhat-actions/s2i-build#readme" target="_blank" rel="noopener">S2I action</a> : Red Hat provides a set of already available actions for OpenShift, in this case there is the . Similarly to what you implemented in the previous chapters, it will create a container image from the source code thanks to the S2I mechanism.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><a href="https://github.com/redhat-actions/push-to-registry#readme" target="_blank" rel="noopener">Push to Registry</a> : This action is used to push to the GitHub Registry using built-in credentials available for GitHub repository owners.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><a href="https://github.com/redhat-actions/oc-login#readme" target="_blank" rel="noopener">OC Login</a>: This action is used to login to the OpenShift cluster with the Environment Secrets previously created.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Run a script already available in the path for GitHub actions (it was provided to make the flow easier and available with the fork of the repository).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>GitHub Actions can invoke script in the path of the workflow.
This script will check if the update the image hash into the Nationalpark Deployment with the one created within this job, otherwise if will create a new Deployment if this is not present yet.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/openshift-roadshow/nationalparks/blob/master/.github/script.sh" target="_blank" rel="noopener">script.sh</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash

app_name=$1
image=$2
namespace=$3

deploy=`oc get deployment $app_name`
if [[ "$?" -eq 0 ]]; then
    oc set image deployment/$app_name $app_name=$image
    oc rollout restart deployment/$app_name
else
    oc new-app $image --name $app_name -n $namespace
fi</code></pre>
</div>
</div>
<div class="paragraph">
<p>From your Nationalparks repository fork on GitHub, go to the top-right menu, click <strong>Actions</strong>.</p>
</div>
<div class="paragraph">
<p>Then click to <strong>set up a workflow yourself</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/nationalparks-codechanges-github-actions-create1.png" alt="Create Workflow">
</div>
</div>
<div class="paragraph">
<p>Rename the <code>main.yml</code> example new file to:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">openshift.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Paste the previously copied YAML content into the code text box under <strong>Edit new file</strong>, replacing the example one.</p>
</div>
<div class="paragraph">
<p>Click <strong>Start Commit</strong>. Add a title for your commit and click <strong>Commit new file</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/nationalparks-codechanges-github-actions-create2.png" alt="Create OpenShift Action">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you are not using GitHub web interface, you can just commit and push the YAML content in a new file under this path <code>.github/workflows/openshift.yml</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can click to your newly created action to gather info about execution and logs as follows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/nationalparks-codechanges-github-actions-created.png" alt="GitHub Action created">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/nationalparks-codechanges-github-actions-running.png" alt="GitHub Action running">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/nationalparks-codechanges-github-actions-running-logs.png" alt="GitHub Action logs">
</div>
</div>
<div class="paragraph">
<p>If everything is fine, you should see a successful status of your OpenShift GitHub action.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/nationalparks-codechanges-github-actions-completed.png" alt="GitHub Action completed">
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s now verify that the Nationparks deployment is pointing to container image on GitHub Registry.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get deployment nationalparks -o=jsonpath='{$.spec.template.spec.containers[:1].image}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should have an output similar to the following:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ghcr.io/blues-man/nationalparks:ced212c4391ffb2ef42af60d295fce4f1551d0e</code></pre>
</div>
</div>
<div class="paragraph">
<p>Congratulations! Any new change to the Nationalparks backend will be now managed by GitHub Actions.</p>
</div>
<div class="paragraph">
<p>If you are interested in bringing more automation to your OpenShift cluster with GitHub actions, please explore all available <a href="https://github.com/redhat-actions" target="_blank" rel="noopener">Red Hat Actions</a> and <a href="https://docs.github.com/en/actions" target="_blank" rel="noopener">GitHub Actions documentation</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Your workshop is completed at this point if you are using <a href="https://developers.redhat.com/developer-sandbox" target="_blank" rel="noopener">Developer Sandbox for Red Hat OpenShift</a>, since in the following chapters there will be functionalities which are not available yet on Sandbox environments (OpenShift Pipelines Operator).
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="enable_openshift_triggers"><a class="anchor" href="#enable_openshift_triggers"></a>Enable OpenShift Triggers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you want to bring back OpenShift automation for this component, you can enable OpenShift triggers again.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Your GitHub Actions won&#8217;t work again if you re-enable OpenShift triggers since there would be two automation system on the same component.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the following labs you will explore more about Kubernetes-native automation in-cluster with <strong>OpenShift Pipelines</strong>.</p>
</div>
<div class="paragraph">
<p>In order to keep working with automation in-cluster, we need to enable again the triggers managed by OpenShift for the Nationalparks Deployment, as we disabled them in the first steps of this lab.</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc set triggers deployment nationalparks --from-image=nationalparks:latest --containers=nationalparks</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see an output as the following:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">deployment.apps/nationalparks triggers updated</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="pacman-nodejs-codechanges-github.html" class="query-params-link">Webhooks with OpenShift</a></span>
  <span class="next"><a href="pacman-nodejs-pipeline.html" class="query-params-link">Continuous Integration and Pipelines</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
